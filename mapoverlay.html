<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fortnite Drop Map Overlay</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    #map-container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #map-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #marker {
      position: absolute;
      width: 40px;
      height: 40px;
      background: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg') no-repeat center center;
      background-size: contain;
      pointer-events: none;
      transform: translate(-50%, -50%);
      display: none;
      /* Uncomment this for debugging marker visibility */
      /* border: 2px solid red; */
    }
  </style>
</head>
<body>
  <div id="map-container">
    <img id="map-image" src="" alt="Fortnite Map" />
    <div id="marker"></div>
  </div>

  <script>
    window.onload = async () => {
      try {
        // Step 1: Get the chosen location from location.json
        const locationRes = await fetch("location.json", { cache: "no-store" });
        const { location } = await locationRes.json();

        if (!location) {
          console.warn("No location set in location.json.");
          return;
        }

        // Step 2: Get map data from Fortnite API
        const mapRes = await fetch("https://fortnite-api.com/v1/map");
        const mapData = await mapRes.json();

        const imageUrl = mapData.data.images.blank;
        const pois = mapData.data.pois;

        document.getElementById("map-image").src = imageUrl;

        // Step 3: Match POI name robustly
        const normalize = str => str.trim().toLowerCase().replace(/[^\w\s]/gi, '');
        const poi = pois.find(p => normalize(p.name) === normalize(location));

        if (!poi) {
          console.warn(`POI not found: "${location}"`);
          return;
        }

        // Step 4: Wait for image to load, then place marker
        const mapImage = document.getElementById("map-image");
        mapImage.onload = () => {
          const { x, y } = poi.location;
          const marker = document.getElementById("marker");

          const container = document.getElementById("map-container");
          const containerWidth = container.clientWidth;
          const containerHeight = container.clientHeight;

          const mapWidthUnits = 10240;
          const mapHeightUnits = 10240;

          const offsetX = (x + 5120) / mapWidthUnits;
          const offsetY = 1 - (y + 5120) / mapHeightUnits;

          const pixelX = offsetX * containerWidth;
          const pixelY = offsetY * containerHeight;

          marker.style.left = `${pixelX}px`;
          marker.style.top = `${pixelY}px`;
          marker.style.display = "block";
        };

      } catch (err) {
        console.error("Error loading map overlay:", err);
      }
    };
  </script>
</body>
</html>
